<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: utils/updateExpensesToMatchTravelRangeDates.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: utils/updateExpensesToMatchTravelRangeDates.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module utils/updateExpensesToMatchTravelRangeDates
 */


const Expense = require('../models/Expense');
const Currency = require('../models/Currency');

const { findRatesByExactOrClosestDate } = require('./utils');
const { convertRateToHomeCurrencyRate } = require('./utils');

const { addLogger } = require('../config/logger');

const pathDepth = module.paths.length - 6;
const Logger = addLogger(__filename, pathDepth);

/**
 * Returns if expense date is not in travel's date range.
 *
 * Either is greater than dateTo or lower than dateFrom.
 *
 * @param {Date} expDate Expense date.
 * @param {Date} travelDateFrom Travel date when the travel starts.
 * @param {Date} travelDateTo Travel date when the travel ends.
 * @returns {boolean} If not in travel dates range true otherwise false.
 */
function checkExpenseDate(expDate, travelDateFrom, travelDateTo) {
  const condition = expDate &lt; travelDateFrom || expDate > travelDateTo;
  Logger.debug(`Cheking expense date. Date in travel's dates: ${!condition}`);
  if (condition) {
    return true;
  }
  return false;
}

/**
 * Returns new expense, based on travel dates range.
 *
 * @param {Date} expDate Expense date.
 * @param {Date} travelDateFrom Travel date when the travel starts.
 * @param {Date} travelDateTo Travel date when the travel ends.
 * @returns {Date} travelDateFrom || travelDateTo
 */
function setNewExpenseDate(expDate, travelDateFrom, travelDateTo) {
  if (expDate &lt; travelDateFrom) {
    Logger.debug(`Expense date is lower than travel date from: ${expDate} &lt; ${travelDateFrom}`);
    return travelDateFrom;
  } if (expDate > travelDateTo) {
    Logger.debug(`Expense date is greater than travel date to: ${expDate} > ${travelDateTo}`);
    return travelDateTo;
  }
}

/**
 * @typedef {Object} NewCurrency
 * @type {Object}
 * @property {Currency} curRate - Currency
 * @property {Number} convertedRate - Converted rate
 */

/**
 * Create new currency object based on user default currency.
 *
 * @param {Date} expensesDate Expense date
 * @param {string} homeCurrency User default currency
 * @param {string} invoiceCurrency Invoice currency
 * @returns {...NewCurrency} {@link NewCurrency} Object with currency object and rate.
 */
async function createNewCurrency(expenseDate, homeCurrency, invoiceCurrency) {
  Logger.debug('Creating new currency');
  try {
    let cur = {};
    const dateRates = await findRatesByExactOrClosestDate(expenseDate);
    const convertedRate = await convertRateToHomeCurrencyRate(
      dateRates.rates,
      homeCurrency,
      invoiceCurrency
    );
    cur[invoiceCurrency] = convertedRate;
    const curRate = new Currency({
      base: homeCurrency,
      date: expenseDate,
      rate: cur
    });
    Logger.debug(`New currency: {base: ${curRate.base}, date: ${curRate.date}, rate: ${cur.toString()}}`);
    /** @type {NewCurrency} */
    return { curRate, convertedRate };
  } catch (err) {
    throw new Error(err);
  }
}

// TODO jsdoc
async function updateExpense(
  expenseId,
  expenseAmount,
  expenseDate,
  convertedRate,
  rateObjectId
) {
  try {
    const amountConverted = Number((expenseAmount / convertedRate).toFixed(2));
    let doc = await Expense.findByIdAndUpdate(expenseId, {
      $set: {
        date: expenseDate,
        curRate: rateObjectId,
        amountConverted
      }
    });
    return doc;
  } catch (err) {
    throw new Error(err);
  }
}

// TODO jsdoc
// FIXME Promise executor functions should not be async
// eslint-disable-next-line no-async-promise-executor
module.exports = async travel => new Promise(async (resolve, reject) => {
  const { dateFrom } = travel;
  const { dateTo } = travel;
  const travelHomeCurrency = travel.homeCurrency;
  const { expenses } = travel;
  const result = [];

  try {
    await expenses.forEach(async expense => {
      if (checkExpenseDate(expense.date, dateFrom, dateTo)) {
        expense.date = setNewExpenseDate(expense.date, dateFrom, dateTo);

        if (expense.type !== 'Mileage') {
          let invoiceCurrency = Object.keys(expense.curRate.rate)[0];
          Currency.find(
            { base: travelHomeCurrency, date: expense.date },
            async (err, curRates) => {
              const filertedRatesFromDB = curRates.filter(
                // eslint-disable-next-line no-restricted-globals
                item => !isNaN(item.rate[invoiceCurrency])
              );
              if (filertedRatesFromDB.length === 0) {
                const { curRate, convertedRate } = await createNewCurrency(
                  expense.date,
                  travelHomeCurrency,
                  invoiceCurrency
                );
                await curRate.save();
                const rateObjectId = curRate._id;
                await updateExpense(
                  expense._id,
                  expense.amount,
                  expense.date,
                  convertedRate,
                  rateObjectId
                ).then(doc => {
                  result.push(doc);
                  if (result.length === expenses.length) {
                    resolve(result);
                  }
                });
              } else {
                const convertedRate =
                    filertedRatesFromDB[0].rate[invoiceCurrency];
                const rateObjectId = filertedRatesFromDB[0]._id;
                await updateExpense(
                  expense._id,
                  expense.amount,
                  expense.date,
                  convertedRate,
                  rateObjectId
                ).then(doc => {
                  result.push(doc);
                  if (result.length === expenses.length) {
                    resolve(result);
                  }
                });
              }
            }
          );
        } else {
          await expense.save(doc => {
            result.push(doc);
            if (result.length === expenses.length) {
              resolve(result);
            }
          });
        }
      } else {
        result.push(expense);
        if (result.length === expenses.length) {
          resolve(result);
        }
      }
    });
  } catch (err) {
    reject(new Error(err));
  }
});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-config_index.html">config/index</a></li><li><a href="module-models_Currency.html">models/Currency</a></li><li><a href="module-models_Expense.html">models/Expense</a></li><li><a href="module-models_Rate.html">models/Rate</a></li><li><a href="module-models_Travel.html">models/Travel</a></li><li><a href="module-models_User.html">models/User</a></li><li><a href="module-utils_getRates.html">utils/getRates</a></li><li><a href="module-utils_hbsHelpers.html">utils/hbsHelpers</a></li><li><a href="module-utils_myErrors.html">utils/myErrors</a></li><li><a href="module-utils_postImport.html">utils/postImport</a></li><li><a href="module-utils_travelExpensesToPDF.html">utils/travelExpensesToPDF</a></li><li><a href="module-utils_travelsTotalToPDF.html">utils/travelsTotalToPDF</a></li><li><a href="module-utils_updateExpensesToMatchTravelRangeDates.html">utils/updateExpensesToMatchTravelRangeDates</a></li><li><a href="module-utils_utils.html">utils/utils</a></li></ul><h3>Classes</h3><ul><li><a href="module-models_Currency-Currency.html">Currency</a></li><li><a href="module-models_Expense-Expense.html">Expense</a></li><li><a href="module-models_Rate-Rate.html">Rate</a></li><li><a href="module-models_Travel-Travel.html">Travel</a></li><li><a href="module-models_User-User.html">User</a></li><li><a href="module-utils_myErrors-ImportFileError.html">ImportFileError</a></li><li><a href="module-utils_myErrors-SaveToDbError.html">SaveToDbError</a></li></ul><h3>Global</h3><ul><li><a href="global.html#deleteExpense">deleteExpense</a></li><li><a href="global.html#getAccount">getAccount</a></li><li><a href="global.html#getContact">getContact</a></li><li><a href="global.html#getExpense">getExpense</a></li><li><a href="global.html#getForgot">getForgot</a></li><li><a href="global.html#getImport">getImport</a></li><li><a href="global.html#getLogin">getLogin</a></li><li><a href="global.html#getOauthUnlink">getOauthUnlink</a></li><li><a href="global.html#getReset">getReset</a></li><li><a href="global.html#getSignup">getSignup</a></li><li><a href="global.html#getTravel">getTravel</a></li><li><a href="global.html#index">index</a></li><li><a href="global.html#isAuthenticated">isAuthenticated</a></li><li><a href="global.html#isAuthorized">isAuthorized</a></li><li><a href="global.html#logout">logout</a></li><li><a href="global.html#postContact">postContact</a></li><li><a href="global.html#postDeleteAccount">postDeleteAccount</a></li><li><a href="global.html#postForgot">postForgot</a></li><li><a href="global.html#postImport">postImport</a></li><li><a href="global.html#postLogin">postLogin</a></li><li><a href="global.html#postNewExpense">postNewExpense</a></li><li><a href="global.html#postReset">postReset</a></li><li><a href="global.html#postSignup">postSignup</a></li><li><a href="global.html#postUpdatePassword">postUpdatePassword</a></li><li><a href="global.html#postUpdateProfile">postUpdateProfile</a></li><li><a href="global.html#updateExpense">updateExpense</a></li><li><a href="global.html#updateTravel">updateTravel</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Sun Dec 08 2019 12:43:45 GMT+0100 (GMT+01:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
