<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>controllers/expense.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="http://localhost:8080" target="_blank" class="menu-item" id="website_link" >TravelApp</a></h2><h3>Classes</h3><ul><li><a href="Logger.html">Logger</a></li></ul><h3>Modules</h3><ul><li><a href="module-app.html">app</a></li><li><a href="module-config.html">config</a></li><li><a href="module-config_error.html">config/error</a></li><li><a href="module-config_express.html">config/express</a></li><li><a href="module-config_LoggerClass.html">config/LoggerClass</a></li><li><a href="module-config_mongoose.html">config/mongoose</a></li><li><a href="module-config_passport.html">config/passport</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-config_passport.html">isAuthenticated</a></li><li data-type='method' style='display: none;'><a href="module-config_passport.html">isAuthorized</a></li></ul></li><li><a href="module-config_routes.html">config/routes</a></li><li><a href="module-config_routes_expenses.html">config/routes/expenses</a></li><li><a href="module-config_routes_oAuth.html">config/routes/oAuth</a></li><li><a href="module-config_routes_travels.html">config/routes/travels</a></li><li><a href="module-config_routes_user.html">config/routes/user</a></li><li><a href="module-controllers_contact.html">controllers/contact</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-controllers_contact.html">getContact</a></li><li data-type='method' style='display: none;'><a href="module-controllers_contact.html">postContact</a></li></ul></li><li><a href="module-controllers_expense.html">controllers/expense</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-controllers_expense.html#.deleteExpense">deleteExpense</a></li><li data-type='method' style='display: none;'><a href="module-controllers_expense.html#.getExpense">getExpense</a></li><li data-type='method' style='display: none;'><a href="module-controllers_expense.html#.postNewExpense">postNewExpense</a></li><li data-type='method' style='display: none;'><a href="module-controllers_expense.html#.updateExpense">updateExpense</a></li></ul></li><li><a href="module-controllers_home.html">controllers/home</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-controllers_home.html#.index">index</a></li></ul></li><li><a href="module-controllers_import.html">controllers/import</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-controllers_import.html#.getImport">getImport</a></li><li data-type='method' style='display: none;'><a href="module-controllers_import.html#.postImport">postImport</a></li></ul></li><li><a href="module-controllers_travel.html">controllers/travel</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-controllers_travel.html#.deleteTravel">deleteTravel</a></li><li data-type='method' style='display: none;'><a href="module-controllers_travel.html#.getNewTravel">getNewTravel</a></li><li data-type='method' style='display: none;'><a href="module-controllers_travel.html#.getTravel">getTravel</a></li><li data-type='method' style='display: none;'><a href="module-controllers_travel.html#.getTravelExpensesPDF">getTravelExpensesPDF</a></li><li data-type='method' style='display: none;'><a href="module-controllers_travel.html#.getTravels">getTravels</a></li><li data-type='method' style='display: none;'><a href="module-controllers_travel.html#.getTravelsTotalPDF">getTravelsTotalPDF</a></li><li data-type='method' style='display: none;'><a href="module-controllers_travel.html#.postNewTravel">postNewTravel</a></li><li data-type='method' style='display: none;'><a href="module-controllers_travel.html#.updateTravel">updateTravel</a></li></ul></li><li><a href="module-controllers_user.html">controllers/user</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-controllers_user.html#.getAccount">getAccount</a></li><li data-type='method' style='display: none;'><a href="module-controllers_user.html#.getForgot">getForgot</a></li><li data-type='method' style='display: none;'><a href="module-controllers_user.html#.getLogin">getLogin</a></li><li data-type='method' style='display: none;'><a href="module-controllers_user.html#.getOauthUnlink">getOauthUnlink</a></li><li data-type='method' style='display: none;'><a href="module-controllers_user.html#.getReset">getReset</a></li><li data-type='method' style='display: none;'><a href="module-controllers_user.html#.getSignup">getSignup</a></li><li data-type='method' style='display: none;'><a href="module-controllers_user.html#.logout">logout</a></li><li data-type='method' style='display: none;'><a href="module-controllers_user.html#.postDeleteAccount">postDeleteAccount</a></li><li data-type='method' style='display: none;'><a href="module-controllers_user.html#.postForgot">postForgot</a></li><li data-type='method' style='display: none;'><a href="module-controllers_user.html#.postLogin">postLogin</a></li><li data-type='method' style='display: none;'><a href="module-controllers_user.html#.postReset">postReset</a></li><li data-type='method' style='display: none;'><a href="module-controllers_user.html#.postSignup">postSignup</a></li><li data-type='method' style='display: none;'><a href="module-controllers_user.html#.postUpdatePassword">postUpdatePassword</a></li><li data-type='method' style='display: none;'><a href="module-controllers_user.html#.postUpdateProfile">postUpdateProfile</a></li></ul></li><li><a href="module-utils_getTrace.html">utils/getTrace</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-utils_getTrace.html#getTrace">getTrace</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">controllers/expense.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* eslint-disable quote-props */
const mongoose = require('mongoose');
const _ = require('lodash');
const moment = require('moment');

const LoggerClass = require('../config/LoggerClass');

const Logger = new LoggerClass('expense');
const { mainLogger, logger } = Logger;
mainLogger.debug('controllers\\expense INITIALIZING!');

const Travel = require('../models/Travel');
const Expense = require('../models/Expense');
const Currency = require('../models/Currency');

const { ObjectId } = mongoose.Types;

const { expenseTypes } = require('../lib/globals');
const constants = require('../lib/constants');

/**
 * Expense routes.
 * @module controllers/expense
 * @requires NPM:mongoose
 * @requires NPM:lodash
 * @requires NPM:moment
 * @requires module:config/LoggerClass
 * @requires module:models/Travel
 * @requires module:models/Expense
 * @requires module:models/Currency
 * @requires module:lib/globals
 * @requires module:lib/constants
 * @see {@link https://www.npmjs.com/package/mongoose NPM:mongoose}
 * @see {@link https://www.npmjs.com/package/lodash NPM:lodash}
 * @see {@link https://www.npmjs.com/package/moment NPM:moment}
 */

/**
 * GET /travels/:id/expenses/:id
 *
 * Get expense by id.
 * @param {http.request} req
 * @param {http.response} res
 * @param {function} next
 */
exports.getExpense = (req, res, next) => {
  logger.debug('Getting expense');
  const { id } = req.params;
  if (!ObjectId.isValid(id)) {
    return next(new Error('Not valid Object Id'));
  }
  let mileageType;
  const { expense } = res.locals;
  const { travel } = res.locals;
  const tDateFrom = travel.dateFrom;
  const tDateTo = travel.dateTo;

  if (expense.type !== 'Mileage') {
    const rate = Object.values(expense.curRate.rate)[0];
    expense.rate = rate.toFixed(2);
    mileageType = false;
  } else {
    expense.rate = travel.perMileAmount;
    mileageType = true;
  }

  res.render('expenses/expense', {
    title: 'Expense',
    travel,
    expense,
    mileageType,
    tDateFrom,
    tDateTo,
    constants,
    rates: JSON.stringify(res.locals.rates),
    expenseCurRate: JSON.stringify(expense.curRate),
    expenseTypes
  });
};

/**
 * DELETE /travels/:id/expenses/:id
 *
 * Delete expense with id.
 * @param {http.request} req
 * @param {http.response} res
 * @param {function} next
 */
exports.deleteExpense = async (req, res, next) => {
  logger.debug('Deleting expense');
  const expenseId = req.params.id;
  const { travel } = res.locals;
  const { expense } = res.locals;
  Expense.findOneAndDelete({ _id: expenseId, travel: travel._id })
    .then(() => {
      Travel.findByIdAndUpdate(
        travel._id,
        {
          $pullAll: { expenses: [expenseId] },
          $inc: { total: -expense.amountConverted }
        },
        err => {
          if (!err) {
            return next(err);
          }
        }
      );
    })
    .then(() => {
      req.flash('info', { msg: 'Expense successfully deleted!!' });
      res.redirect(`/travels/${travel._id}`);
    })
    .catch(err => {
      next(err);
    });
};

/**
 * PATCH /travels/:id/expenses/:id
 *
 * Update(PATCH) expense with id.
 * @param {http.request} req
 * @param {http.response} res
 * @param {function} next
 */
exports.updateExpense = async (req, res, next) => {
  logger.debug('Updating expense');
  const { travel } = res.locals;
  const { expense } = res.locals;

  const currencyOptions = {
    allow_negatives: false,
    allow_negative_sign_placeholder: true,
    thousands_separator: ',',
    decimal_separator: '.',
    allow_decimal: true,
    require_decimal: false,
    digits_after_decimal: [2],
    allow_space_after_digits: false
  };
  const decimalOptions = { decimal_digits: 2 };

  req
    .assert(
      'expenseDescription',
      'Description is empty or to long (max 60 characters)!'
    )
    .isLength({ min: 1, max: 60 });
  let dateCompare = moment(res.locals.travel.dateFrom)
    .add(-1, 'days')
    .format('YYYY-MM-DD');
  req
    .assert('invoiceDate', 'Invoice date should be within travel dates')
    .isAfter(dateCompare);
  dateCompare = moment(res.locals.travel.dateTo)
    .add(1, 'days')
    .format('YYYY-MM-DD');
  req
    .assert('invoiceDate', 'Invoice date should be within travel dates')
    .isBefore(dateCompare);

  if (req.body.expenseType === 'Mileage') {
    req
      .assert(
        'travelPerMileAmount',
        'Per mile amount should be positive number with 2 decimals!'
      )
      .isDecimal(decimalOptions);
    req
      .assert('invoiceUnit', 'Must be "km" or "mi"')
      .custom(
        () => req.body.invoiceUnit === 'km' || req.body.invoiceUnit === 'mi'
      );
    req
      .assert('amountDistance', 'Number with 2 decimals')
      .isDecimal(decimalOptions);
    req
      .assert('amountDistance2', 'Number with 2 decimals')
      .isDecimal(decimalOptions);
    req
      .assert('amountConverted2', 'Number with 2 decimals')
      .isDecimal(decimalOptions);
  } else {
    req
      .assert('invoiceCurrency', 'Currency name must be 3 characters long')
      .isLength({ min: 3, max: 3 });
    req
      .assert('rate', 'Currency rate with 2 decimals')
      .isNumeric()
      .isCurrency(currencyOptions);
    req.assert('amount', 'Number with 2 decimals').isDecimal(decimalOptions);
    req
      .assert('amountConverted', 'Number with 2 decimals')
      .isDecimal(decimalOptions);
  }

  const errors = req.validationErrors();

  if (errors) {
    req.flash('errors', errors);
    return res.redirect(`/travels/${travel._id}`);
  }

  const body = _.pick(req.body, [
    'expenseType',
    'expenseDescription',
    'invoiceDate',
    'amountDistance',
    'amountDistance2',
    'amountConverted',
    'amountConverted2',
    'invoiceCurrency',
    'rate',
    'amount'
  ]);
  const invoiceDate = new Date(req.body.invoiceDate);
  travel.total = (
    travel.total -
    Number(expense.amountConverted) +
    Number(body.amountConverted) +
    Number(body.amountConverted2)
  ).toFixed(2);
  // Different data if expense type is Mileage
  if (req.body.expenseType !== 'Mileage') {
    const invoiceCurrency = req.body.invoiceCurrency.toUpperCase();
    moment(invoiceDate).format('YYYY-MM-DD');
    const { rate } = req.body;
    let cur = {};

    cur[invoiceCurrency] = Number(rate);
    let curRate = {};
    await Currency.find(
      {
        base: res.locals.travel.homeCurrency,
        date: invoiceDate,
        rate: cur
      },
      async (err, item) => {
        if (item.length === 1) {
          // eslint-disable-next-line prefer-destructuring
          curRate = item[0];
        } else {
          curRate = new Currency({
            base: res.locals.travel.homeCurrency,
            date: invoiceDate,
            rate: cur
          });
          await curRate
            .save()
            .then(() => {})
            .catch(err => {
              next(err);
            });
        }
      }
    );

    expense.type = body.expenseType;
    expense.description = body.expenseDescription;
    expense.date = invoiceDate;
    expense.currency = body.invoiceCurrency.toUpperCase();
    expense.curRate = curRate;
    expense.amount = body.amount;
    expense.amountConverted = body.amountConverted;
    expense.unit = undefined;
  } else {
    expense.type = body.expenseType;
    expense.description = body.expenseDescription;
    expense.date = invoiceDate;
    expense.unit = req.user.homeDistance;
    expense.amount = body.amountDistance;
    expense.amountConverted = body.amountConverted2;
    expense.currency = undefined;
    expense.curRate = undefined;
  }

  await expense
    .save()
    .then(() => {
      travel
        .save()
        .then(() => {
          req.flash('info', { msg: 'Expense successfully updated!' });
          res.redirect(`/travels/${travel._id}`);
        })
        .catch(err => {
          next(err);
        });
    })
    .catch(err => {
      next(err);
    });
};

/**
 * POST /travels/:id/expenses/new
 *
 * Post new expense.
 * @param {http.request} req
 * @param {http.response} res
 * @param {function} next
 */
exports.postNewExpense = async (req, res, next) => {
  logger.debug('Creating new expense');
  const currencyOptions = {
    allow_negatives: false,
    allow_negative_sign_placeholder: true,
    thousands_separator: ',',
    decimal_separator: '.',
    allow_decimal: true,
    require_decimal: false,
    digits_after_decimal: [2],
    allow_space_after_digits: false
  };
  const decimalOptions = { decimal_digits: 2 };

  req
    .assert(
      'expenseDescription',
      'Description is empty or to long (max 60 characters)!'
    )
    .isLength({ min: 1, max: 60 });
  let dateCompare = moment(res.locals.travel.dateFrom)
    .add(-1, 'days')
    .format('YYYY-MM-DD');
  req
    .assert('invoiceDate', 'Invoice date should be within travel dates')
    .isAfter(dateCompare);
  dateCompare = moment(res.locals.travel.dateTo)
    .add(1, 'days')
    .format('YYYY-MM-DD');
  req
    .assert('invoiceDate', 'Invoice date should be within travel dates')
    .isBefore(dateCompare);

  if (req.body.expenseType === 'Mileage') {
    req
      .assert(
        'travelPerMileAmount',
        'Per mile amount should be positive number with 2 decimals!'
      )
      .isDecimal(decimalOptions);
    req
      .assert('invoiceUnit', 'Must be "km" or "mi"')
      .custom(
        () => req.body.invoiceUnit === 'km' || req.body.invoiceUnit === 'mi'
      );
    req
      .assert('amountDistance', 'Number with 2 decimals')
      .isDecimal(decimalOptions);
    req
      .assert('amountDistance2', 'Number with 2 decimals')
      .isDecimal(decimalOptions);
    req
      .assert('amountConverted2', 'Number with 2 decimals')
      .isDecimal(decimalOptions);
  } else {
    req
      .assert('invoiceCurrency', 'Currency name must be 3 characters long')
      .isLength({ min: 3, max: 3 });
    req
      .assert('rate', 'Currency rate with 2 decimals')
      .isNumeric()
      .isCurrency(currencyOptions);
    req.assert('amount', 'Number with 2 decimals').isDecimal(decimalOptions);
    req
      .assert('amountConverted', 'Number with 2 decimals')
      .isDecimal(decimalOptions);
  }

  const errors = req.validationErrors();

  if (errors) {
    req.flash('errors', errors);
    return res.redirect(`/travels/${req.params.id}`);
  }

  let expense = {};
  const invoiceDate = new Date(req.body.invoiceDate);

  // Different data if expense type is Mileage
  if (req.body.expenseType !== 'Mileage') {
    const invoiceCurrency = req.body.invoiceCurrency.toUpperCase();
    const { rate } = req.body;
    let cur = {};

    cur[invoiceCurrency] = Number(rate);
    let curRate = {};
    await Currency.find(
      {
        base: res.locals.travel.homeCurrency,
        date: invoiceDate,
        rate: cur
      },
      async (err, item) => {
        if (item.length === 1) {
          // eslint-disable-next-line prefer-destructuring
          curRate = item[0];
        } else {
          curRate = new Currency({
            base: res.locals.travel.homeCurrency,
            date: invoiceDate,
            rate: cur
          });
          await curRate.save();
        }
      }
    );

    expense = new Expense({
      travel: req.params.id,
      type: req.body.expenseType,
      description: req.body.expenseDescription,
      date: invoiceDate,
      currency: req.body.invoiceCurrency.toUpperCase(),
      curRate,
      amount: req.body.amount,
      amountConverted: req.body.amountConverted,
      _user: req.user._id
    });
  } else {
    expense = new Expense({
      travel: req.params.id,
      type: req.body.expenseType,
      description: req.body.expenseDescription,
      date: invoiceDate,
      unit: req.user.homeDistance,
      amount: req.body.amountDistance,
      amountConverted: req.body.amountConverted2,
      _user: req.user._id
    });
  }

  try {
    const doc = await expense.save();
    const travel = await Travel.findByIdAndUpdate(
      res.locals.travel._id,
      { $addToSet: { expenses: doc._id } },
      err => {
        if (err) {
          return next(err);
        }
      }
    );
    // TODO refactor if statement. No need for if statement.
    if (doc.type !== 'Mileage') {
      const result = Number(travel.total) + Number(doc.amountConverted);
      travel.total = result.toFixed(2);
      travel.save();
    } else {
      const result = Number(travel.total) + Number(doc.amountConverted);
      travel.total = result.toFixed(2);
      travel.save();
    }
  } catch (err) {
    return next(err);
  }

  req.flash('success', { msg: 'Successfully added new expense!' });
  res.redirect(`/travels/${req.params.id}`);
};
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> on Sun Dec 15 2019 13:09:44 GMT+0100 (GMT+01:00) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
